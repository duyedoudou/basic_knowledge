### Socket是什么

------

实际上socket是对TCP/IP协议的封装，它的出现只是使得程序员更方便地使用TCP/IP协议栈而已。socket本身并不是协议，Socket是应用层与TCP/IP协议族通信**中间软件抽象层**，它是一组接口。



![img](https://img-blog.csdn.net/20160803140023934?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

##### 通信过程：

![img](https://img-blog.csdn.net/20160803140033309?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

主机A的应用程序要能和主机B的应用程序通信，必须通过`Socket建立连接`。

而建立Socket连接必须需要底TCP/IP协议来`建立TCP连接`。

建立TCP连接需要`底层IP协议`来寻址网络中的主机。

网络层使用的IP协议可以帮助我们根据IP地址来找到目标主机。

但是一台主机上可能运行着多个应用程序，如何才能与指定的应用程序通信就要通过`端口号`来指定。这样就可以通过Socket实例==唯一代表==一个主机上的一个应用程序的通信链路了。

##### 建立通信链路：

当客户端要与服务器端通信，客户端首先要创建一个Socket实例，操作系统将为这个Socket实例分配一个没有被使用的本地端口号，并创建一个包含本地和远程地址、端口号的套接字数据结构，这个数据结构将一直保存在系统中直到这个连接关闭。

在创建Socket实例的构造函数正确返回之前，将要进行TCP的三次握手协议，TCP握手协议完成后，Socket实例对象将创建完成，否则将抛出IOException错误。

#### 答疑：

实际上socket是对TCP/IP协议的封装，它的出现只是使得程序员更方便地使用TCP/IP协议栈而已。socket本身并不是协议，Socket是应用层与TCP/IP协议族通信**中间软件抽象层**，它是一组接口。

> “TCP/IP只是一个协议栈，就像操作系统的运行机制一样，必须要具体实现，同时还要提供对外的`操作接口`。
>
> 这个就像操作系统会提供标准的编程接口，比如win32编程接口一样。 
>
> TCP/IP也要提供可供程序员做网络开发所用的接口，这就是Socket编程接口。”

要通过互联网进行通信，至少需要`一对套接字`，一个运行于客户机端，称之为`ClientSocket`，另一个运行于服务器端，称之为`serverSocket`。

根据连接启动的方式以及本地套接字要连接的目标，`套接字之间的连接过程`可以分为三个步骤：

服务器监听，客户端请求，连接确认。

**服务器监听：**是服务器端套接字并不定位具体的客户端套接字，而是处于`等待连接`的状态，实时`监控`网络状态。

**客户端请求：**是指由客户端的套接字提出连接请求，要连接的目标是服务器端的套接字。为此，<u>客户端的套接字必须首先描述它要连接的服务器的套接字</u>，<u>指出服务器端套接字的地址和端口号</u>，然后就向服务器端套接字提出连接请求。

**连接确认：**是指当服务器端套接字`监听到`或者说接收到客户端套接字的连接请求，它就响应客户端套接字的请求，建立一个新的线程，把服务器端套接字的描述发给客户端，一旦客户端确认了此描述，连接就建立好了。而服务器端套接字继续处于监听状态，继续接收其他客户端套接字的连接请求。

在设计模式中，Socket其实就是一个facade模式，它把复杂的TCP/IP协议族隐藏在Socket接口后面，对用户来说，一组简单的接口就是全部，让Socket去组织数据，以符合指定的协议。

#### 类比：

把`TCP服务器`比作政府某一服务部门能，`TCP客户端`比作企业中某一部门电话。这一过程恰好就像是`socket通信`，服务部门提供服务，企业部门申请服务。

要实现通信，首先政府部门都必须申请一个电话（`socket_fd`），并向有关部门`注册`（我们的系统），提供地址（`sockadrr`）以及属于哪个部门的（`port`），录入系统后，就算是合约生效了（`bind`），于是这个服务热线就算开通了，接着就是等待企业家拨打热线（`listen`）。

企业家拨打电话对地点和部门没有这么多的要求了，他并不需要绑定地址和部门，在任何一个可以拨打电话的地方(可能是同个部门，也可以同公司不同部门，甚至可能是竞争对手)，他只需要拿起一个已经注册的电话（`socket_fd`），拨打电话（`connect`），政府部门接通电话（`accept`）后，桥梁就打通了（服务者client_fd、顾客server_fd），可以进行听说了（read write）。企业家咨询完成（close）,政府到点下班关闭服务（`close`）。

